description: Kubernetes Master & Worker with Persistent Volumes + Floating IP + Node
  Exporter
heat_template_version: '2018-08-31'
parameters:
  keypair_name:
    default: mykey
    type: string
  root_volume_size:
    default: 30
    type: number
  ubuntu_image:
    default: Ubuntu 22.04 Jammy
    type: string
resources:
  k8s_master:
    properties:
      block_device_mapping_v2:
      - delete_on_termination: false
        device_name: vda
        volume_id:
          get_resource: master_volume
      flavor: k8s
      key_name:
        get_param: keypair_name
      name: k8s-master
      networks:
      - port:
          get_resource: master_port
      user_data: "#cloud-config\nssh_pwauth: true\n\nusers:\n  - name: k8suser\n \
        \   sudo: ALL=(ALL) NOPASSWD:ALL\n    shell: /bin/bash\n\nchpasswd:\n  list:\
        \ |\n    k8suser:123\n  expire: false\n\nruncmd:\n  - apt-get update\n  -\
        \ apt-get install -y curl wget apt-transport-https ca-certificates gnupg\n\
        \n  # Disable swap\n  - swapoff -a\n  - sed -i '/ swap / s/^/#/' /etc/fstab\n\
        \n  # Kernel modules\n  - |\n    cat <<EOF | tee /etc/modules-load.d/k8s.conf\n\
        \    overlay\n    br_netfilter\n    EOF\n  - modprobe overlay\n  - modprobe\
        \ br_netfilter\n\n  # Sysctl\n  - |\n    cat <<EOF | tee /etc/sysctl.d/k8s.conf\n\
        \    net.bridge.bridge-nf-call-iptables = 1\n    net.bridge.bridge-nf-call-ip6tables\
        \ = 1\n    net.ipv4.ip_forward = 1\n    EOF\n  - sysctl --system\n\n  # Node\
        \ Exporter\n  - useradd -rs /bin/false node_exporter || true\n  - wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz\n\
        \  - tar xvf node_exporter-1.7.0.linux-amd64.tar.gz\n  - cp node_exporter-1.7.0.linux-amd64/node_exporter\
        \ /usr/local/bin/\n  - chown node_exporter:node_exporter /usr/local/bin/node_exporter\n\
        \  - |\n    cat <<EOF | tee /etc/systemd/system/node_exporter.service\n  \
        \  [Unit]\n    Description=Node Exporter\n    After=network.target\n\n   \
        \ [Service]\n    User=node_exporter\n    ExecStart=/usr/local/bin/node_exporter\n\
        \n    [Install]\n    WantedBy=multi-user.target\n    EOF\n  - systemctl daemon-reload\n\
        \  - systemctl enable node_exporter\n  - systemctl start node_exporter\n"
      user_data_format: RAW
    type: OS::Nova::Server
  k8s_worker:
    properties:
      block_device_mapping_v2:
      - delete_on_termination: false
        device_name: vda
        volume_id:
          get_resource: worker_volume
      flavor: k8s
      key_name:
        get_param: keypair_name
      name: k8s-worker
      networks:
      - port:
          get_resource: worker_port
      user_data: "#cloud-config\nssh_pwauth: true\n\nusers:\n  - name: k8suser\n \
        \   sudo: ALL=(ALL) NOPASSWD:ALL\n    shell: /bin/bash\n\nchpasswd:\n  list:\
        \ |\n    k8suser:123\n  expire: false\n\nruncmd:\n  - apt-get update\n  -\
        \ apt-get install -y curl wget apt-transport-https ca-certificates gnupg\n\
        \  - swapoff -a\n  - sed -i '/ swap / s/^/#/' /etc/fstab\n  - modprobe overlay\n\
        \  - modprobe br_netfilter\n  - sysctl -w net.ipv4.ip_forward=1\n  - sysctl\
        \ -w net.bridge.bridge-nf-call-iptables=1\n  - sysctl -w net.bridge.bridge-nf-call-ip6tables=1\n\
        \n  # Node Exporter\n  - useradd -rs /bin/false node_exporter || true\n  -\
        \ wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz\n\
        \  - tar xvf node_exporter-1.7.0.linux-amd64.tar.gz\n  - cp node_exporter-1.7.0.linux-amd64/node_exporter\
        \ /usr/local/bin/\n  - chown node_exporter:node_exporter /usr/local/bin/node_exporter\n\
        \  - systemctl daemon-reload\n  - systemctl enable node_exporter\n  - systemctl\
        \ start node_exporter"
      user_data_format: RAW
    type: OS::Nova::Server
  master_floating_assoc:
    properties:
      floatingip_id:
        get_resource: master_floating_ip
      port_id:
        get_resource: master_port
    type: OS::Neutron::FloatingIPAssociation
  master_floating_ip:
    properties:
      floating_network: provider
    type: OS::Neutron::FloatingIP
  master_port:
    properties:
      network: selfservice
      security_groups:
      - k8s-secgrp
    type: OS::Neutron::Port
  master_volume:
    properties:
      image:
        get_param: ubuntu_image
      name: k8s-master-root
      size:
        get_param: root_volume_size
    type: OS::Cinder::Volume
  worker_floating_assoc:
    properties:
      floatingip_id:
        get_resource: worker_floating_ip
      port_id:
        get_resource: worker_port
    type: OS::Neutron::FloatingIPAssociation
  worker_floating_ip:
    properties:
      floating_network: provider
    type: OS::Neutron::FloatingIP
  worker_port:
    properties:
      network: selfservice
      security_groups:
      - k8s-secgrp
    type: OS::Neutron::Port
  worker_volume:
    properties:
      image:
        get_param: ubuntu_image
      name: k8s-worker-root
      size:
        get_param: root_volume_size
    type: OS::Cinder::Volume